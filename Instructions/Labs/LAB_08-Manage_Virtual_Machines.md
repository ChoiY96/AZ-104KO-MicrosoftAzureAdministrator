---
lab:
    title: '08 - 가상 머신 관리'
    module: '모듈 08 - 가상 머신'
---

# 랩 08 -  가상 머신 관리
# 학생 랩 매뉴얼

## 랩 시나리오

 Azure 가상 머신을 배포하고 구성하기 위한 다양한 옵션을 식별하는 작업을 했습니다. 먼저 Azure 가상 머신을 사용할 때 구현할 수 있는 다양한 컴퓨팅, 저장소 복원력 및 확장성 옵션을 결정해야 합니다. 다음으로 가상 머신 확장 집합을 사용할 때 가능한 컴퓨팅 및 저장소 복원력 및 확장성 옵션을 조사해야 합니다. 또한 Azure Virtual Machine Custom Script 확장 기능을 사용하여 가상 머신 및 가상 머신 확장 집합을 자동으로 구성하는 기능을 탐색하려고 합니다.

## 목적

이 랩에서는 다음 작업을 수행합니다.

+ 작업 1: Azure Portal 및 Azure Resource Manager 템플릿을 사용하여 영역 복원력 있는 Azure 가상 머신 배포
+ 작업 2: 가상 머신 확장을 사용한 Azure 가상 머신 구성
+ 작업 3: Azure 가상 머신에 대한 컴퓨팅 및 스토리지 확장
+ 작업 4: Azure Portal을 사용하여 영역 복원력 있는 Azure Virtual Machine Scale Sets 배포
+ 작업 5: 가상 머신 확장을 사용하여 Azure Virtual Machine Scale Sets 구성
+ 작업 6: Azure Virtual Machine Scale Sets의 컴퓨팅 및 스토리지 크기 조정 (선택 사항)

## 예상 시간: 50분

## 지침

### 연습 1

#### 작업 1: Azure Portal 및 Azure Resource Manager 템플릿을 사용하여 영역 복원력 있는 Azure 가상 머신 배포

이 작업에서는 Azure Portal 및 Azure Resource Manager 템플릿을 사용하여 Azure Virtual Machines을 다른 가용성 영역에 배포합니다.

1. [Azure Portal](http://portal.azure.com)에 로그인합니다.

1. Azure Portal에서 **가상 머신**을 검색하여 선택하고 **가상 머신** 블레이드에서 **+ 추가**를 클릭합니다.

1. **가상 머신 만들기** 블레이드의 **기본** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | 구독 | 이 랩에서 사용할 Azure 구독의 이름 |
    | 리소스 그룹 | 새 리소스 그룹 **az104-LabRG**의 이름 |
    | 가상 머신 이름 | **az104-08-vm0** |
    | 영역 | 가용성 영역을 지원하고 Azure 가상 머신을 프로비전할 수 있는 영역 중 하나를 선택합니다 | 
    | 가용성 옵션 | **가용성 영역** |
    | 가용성 영역 | **1** |
    | 이미지 | **Windows Server 2019 Datacenter** |
    | Azure Spot 인스턴스 | **아니요** |
    | 크기 | **표준 D2s v3** |
    | 사용자 이름 | **학생** |
    | 암호 | **Pa55w.rd1234** |
    | 공용 인바운드 포트 | **없음** |
    | 이미 Windows Server 라이선스가 있습니다 | **아니요** |

1. **다음: 디스크 >** 를 클릭하고 **가상 머신 만들기** 블레이드의 **디스크** 탭에서 다음 설정을 지정합니다 (다른 설정은 기본값으로 남김).    

    | 설정 | 값 | 
    | --- | --- |
    | OS 디스크 유형 | **표준 HDD** |
    | Ultra Disk 호환성 사용 | **아니요** |

1. **다음: 네트워킹 >** 을 클릭하고 **가상 머신 만들기** 블레이드의 **네트워킹** 탭에서 **가상 네트워크** 텍스트 상자 아래의 **새로 만들기**를 클릭합니다. 

1. **가상 네트워크 만들기** 블레이드에서 다음 설정을 지정합니다 (다른 설정은 기본값으로 남습니다). 

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az104-08-rg01-vnet** |
    | 주소 범위 | **10.80.0.0/20** |
    | 서브넷 이름 | **subnet0** |
    | 서브넷 범위 | **10.80.0.0/24** |
 
1.  **확인**을 클릭하고 **가상 머신 만들기** 블레이드의 **네트워킹** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 남겨둡니다).     

    | 설정 | 값 | 
    | --- | --- |
    | 공용 IP | **없음** |
    | NIC 네트워크 보안 그룹 | **없음** |
    | 가속 네트워킹 | **해제** |
    | 기존 부하 분산 솔루션 뒤에 이 가상 머신을 배치하시겠습니까? | **아니요** |

1. **다음: 관리>** 를 클릭하고 **가상 머신 만들기** 블레이드의 **관리** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 남습니다).    

    | 설정 | 값 | 
    | --- | --- |
    | 부팅 진단 | **켜기** |
    | 진단 스토리지 계정 | 기본값 |
	
    >**참고**: 진단 스토리지 계정의 이름을 확인합니다. 다음 작업에 이 값이 필요합니다. 

1. **다음: 고급 >** 을 클릭하고 **가상 머신 만들기** 블레이드의 **고급** 탭에서 사용 가능한 설정을 확인합니다. 아무것도 변경하지 않은 채 **검토 + 만들기**를 클릭합니다.

1. **검토+만들기** 블레이드에서 **만들기**를 클릭합니다.

1. 배포 블레이드에서 **템플릿**을 클릭합니다.

1. 진행 중인 배포를 나타내는 템플릿을 검토하고 **배포**를 클릭합니다.

    >**참고**: 이 옵션을 사용하여 가용성 영역을 제외하고 일치한 구성을 가진 두 번째 가상 머신을 배포합니다. 

1. **사용자 지정 배포** 블레이드에서 다음 설정을 지정합니다(다른 설정은 기본값으로 남깁니다). 

    | 설정 | 값 | 
    | --- | --- |
    | 리소스 그룹 | **az104-08-rg01** |
    | 네트워크 인터페이스 이름 | **az104-08-vm1-nic1** |
    | 가상 머신 이름 | **az104-08-vm1** |
    | 관리자 이름 | **학생** |
    | 관리자 암호 | **Pa55w.rd1234** |
    | 영역 | **2** |

    >**참고**: 가상 머신과 네트워크 인터페이스를 포함한 템플릿을 사용하여 배포하는 고유 리소스의 속성에 해당하는 매개 변수를 수정해야 합니다. 또한 두 개의 가상 머신으로 구성된 배포를 영역 중복으로 유지하려면 다른 가용성 영역을 지정해야 합니다.

1. **위에 명시된 사용 약관에 동의함** 옆의 확인란을 선택하고 **구매**를 클릭합니다.

    >**참고**: 다음 작업을 하기 전에 두 배포가 모두 완료될 때까지 기다립니다. 완료되려면 5분 정도 걸립니다.

#### 작업 2: 가상 머신 확장을 사용한 Azure 가상 머신 구성

이 작업에서는 사용자 지정 스크립트 가상 머신 확장을 사용하여 이전 작업에서 배포한 두 Azure 가상 머신에 Windows Server 웹 서버 역할을 설치합니다. 

1. Azure Portal에서 **스토리지 계정**을 검색 및 선택하고 **스토리지 계정** 블레이드에서 이전 작업에서 만든 진단 스토리지 계정을 나타내는 항목을 클릭합니다.  

1. 스토리지 계정 블레이드에서 **컨테이너**와 **+ 컨테이너**를 차례로 클릭합니다.  

1. **새 컨테이너** 블레이드에서 다음 설정을 지정하고(나머지는 기본값으로 남겨둡니다) **만들기**를 클릭합니다:

    | 설정 | 값 |  
    | --- | --- |
    | 이름 | **scripts** |
    | 공용 액세스 수준 | **프라이빗(익명 액세스 불가**) |
    
1. 컨테이너 목록을 표시하는 스토리지 계정 블레이드로 돌아가 **scripts**를 클릭합니다.

1. **scripts** 블레이드에서 **업로드**를 클릭합니다.

1. **Blob 업로드** 블레이드에서 **열기** 대화 상자의 폴더 아이콘을 클릭하고 **\\Allfiles\\Labs\\08** 폴더로 이동하여 **az104-08-install_IIS.ps1**과 **열기**를 차례로 클릭합니다. 그리고 **Blob 업로드** 블레이드로 돌아와 **업로드**를 클릭합니다. 

1. Azure Portal에서 **가상 머신**을 검색하고 선택하여 선택한 다음 **가상 머신** 블레이드에서 **az104-08-vm0**을 클릭합니다.     

1.  **az104-08-vm0** 가상 머신 블레이드의 **설정** 섹션에서 **확장**을 클릭하고 **+추가**를 클릭합니다.

1. **새 리소스** 블레이드에서 **사용자 지정 스크립트 확장**을 클릭한 다음 **만들기**를 클릭합니다.

1. **확장 설치** 블레이드에서 **찾아보기**를 클릭합니다.  

1. **스토리지 계정** 블레이드에서 **az104-08-install_IIS.ps1** 스크립트를 업로드한 스토리지 계정의 이름을 클릭합니다. **컨테이너** 블레이드에서 **scripts**를 클릭하고 **scripts** 블레이드에서 **az104-08-install_IIS.ps1**와 **선택**을 차례로 클릭합니다.  

1. **확장 설치** 블레이드로 돌아와 **확인**을 클릭합니다.

1. Azure Portal에서 **가상 머신**을 검색하고 선택하고 **가상 머신** 블레이드에서 **az104-08-vm1을** 클릭합니다.     

1.  **az104-08-vm1** 블레이드의 **설정** 섹션에서 **템플릿 내보내기**를 클릭합니다.     

1. **az104-08-vm1-템플릿 내보내기** 블레이드에서 **배포**를 클릭합니다. 

1. **사용자 지정 배포** 블레이드에서 **템플릿 편집**을 클릭합니다.

1. **템플릿 편집** 블레이드의 템플릿의 내용을 표시하는 섹션에서 20번째 줄 부터 다음 코드를 삽입합니다`    "resources": [` 줄 바로 아래):

   ```json
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "az104-08-vm1/customScriptExtension",
            "apiVersion": "2018-06-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "az104-08-vm1"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.7",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "commandToExecute": "powershell.exe Install-WindowsFeature -name Web-Server -IncludeManagementTools && powershell.exe remove-item 'C:\\inetpub\\wwwroot\\iisstart.htm' && powershell.exe Add-Content -Path 'C:\\inetpub\\wwwroot\\iisstart.htm' -Value $('Hello World from ' + $env:computername)"
              }
            }
        },   

   ```

    >**참고**: 본 템플릿 섹션에서는 Azure PowerShell을 통해 첫 번째 가상 머신에 이전에 배포한 것과 동일한 Azure 가상 머신 사용자 지정 스크립트 확장을 정의합니다.

1. **저장**을 클릭하고 **사용자 지정 템플릿** 블레이드로 돌아가 **위에 명시된 이용 약관에 동의함** 확인란을 선택하고 **구입**을 클릭합니다.

    >**참고**: **리소스 템플릿에 있는 하나 이상의 리소스가 지원하지 않는 위치에 리소스 그룹이 있습니다. 다른 리소스 그룹을 선택하세요**. 라는 메시지를 무시하세요. 이 경우는 예상한 것으로 무시할 수 있습니다.

    >**참고**: 템플릿 배포가 완료될 때까지 기다립니다. **az104-08-vm0** 및 **az104-08-vm1** 가상 머신의 **확장** 블레이드에서 진행 상황을 모니터링할 수 있습니다. 작업은 3분 이내에 완료됩니다.

1. 사용자 지정 스크립트 확장 기반 구성이 성공하였는지 확인하려면 **작업** 섹션의 **az104-08-vm1** 블레이드로 되돌아가 **명령 실행**을 클릭하고 명령 목록에서 **RunPowerShellScript**를 클릭합니다.

1. **실행 명령 스크립트** 블레이드에서 다음 내용을 입력하고 **실행**을 클릭하여 **az104-08-vm0**에 호스팅되는 웹 사이트에 접속합니다.

   ```pwsh
   Invoke-WebRequest -URI http://10.80.0.4 -UseBasicParsing
   ```

    >**참고**: cmdlet의 실행을 완료하기 위해 Internet Explorer에 대한 종속성을 제거하려면 **-UseBasicParsing**매개 변수가 필요합니다.

    >**참고**: **az104-08-vm0**에 연결하고 `Invoke-WebRequest-URI http://10.80.0.5`를 실행하여 **az104-08-vm1**에 호스팅되는 웹 사이트에 접속할 수도 있습니다.

#### 작업 3: Azure 가상 머신에 대한 컴퓨팅 및 저장소 확장

이 작업에서는 크기를 변경하여 Azure 가상 머신에 대한 컴퓨팅을 확장하고 데이터 디스크를 연결하고 구성하여 스토리지를 확장합니다.

1. Azure Portal에서 **가상 머신**을 검색하고 선택하여 선택한 다음 **가상 머신** 블레이드에서 **az104-08-vm0**을 클릭합니다.     

1.  **az104-08-vm0** 가상 머신 블레이드에서 **크기**를 클릭하고 가상 머신 크기를 표준 **DS1_v2**로 설정합니다

    >**참고**: **표준 DS1_v2**를 사용할 수 없는 경우 다른 크기를 선택하십시오. 

1.  **az104-08-vm0** 가상 머신 블레이드에서 **디스크**를 클릭하고 **+ 데이터 디스크 추가**를 클릭한 다음 **이름** 드롭다운 목록에서 **디스크 만들기**를 클릭합니다.

1. 다음 설정으로 관리 디스크를 만듭니다(다른 값은 기본값으로 남겨둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | 디스크 이름 | **az104-08-vm0-datadisk-0** |
    | 원본 유형 | **없음** |
    | 계정 유형 | **프리미엄 SSD** |
    | 크기 | **1024 GiB** |


1. **az104-08-vm0 - 디스크** 블레이드로 돌아가 **+데이터 디스크 추가**를 클릭하고 **이름** 드롭 다운 목록에서 **디스크 만들기**를 클릭합니다.

1. 다음 설정으로 관리 디스크를 만듭니다(다른 값은 기본값으로 남겨둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | 디스크 이름 | **az104-08-vm0-datadisk-1** |
    | 원본 유형 | **없음** |
    | 계정 유형 | **프리미엄 SSD** |
    | 크기 | **1024 GiB** |

1. **az104-08-vm0 - 디스크** 블레이드로 돌아가 **저장**을 클릭합니다.

1. **az104-08-vm0** 블레이드 **작업** 섹션에서 **명령 실행**을 클릭하고 명령 목록에서 **RunPowerShellScript**를 클릭합니다. 

1. **명령 스크립트 실행** 블레이드에서 다음 내용을 입력하고 **실행**을 클릭하여 간단한 레이아웃 및 고정 프로비전이 있는 두 개의 새로 연결된 디스크로 구성된 드라이브 Z를 만듭니다:

   ```pwsh
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```

    > **참고**: 명령 완료가 확인될 때까지 기다립니다.

1. Azure Portal에서 **가상 머신**을 검색하고 선택하고 **가상 머신** 블레이드에서 **az104-08-vm1**을 클릭합니다.     

1.  **az104-08-vm1** 블레이드의 **설정** 섹션에서 **템플릿 내보내기**를 클릭합니다.     

1. **az104-08-vm1-템플릿 내보내기** 블레이드에서 **배포**를 클릭합니다. 

1. **사용자 지정 배포** 블레이드에서 **템플릿 편집**을 클릭합니다.

1. **템플릿 편집** 블레이드의 템플릿 내용 표시 섹션에서 30번째 줄 `                    "vmSize": "Standard_D2s_v3"`을 다음으로 바꿉니다.

   ```json
                    "vmSize": "Standard_DS1_v2"

   ```

    >**참고**: 본 템플릿 섹션에서는 Azure Portal을 통해 첫 번째 가상 머신에 대해 지정한 것과 동일한 Azure 가상 머신 크기를 정의합니다.


1. **템플릿 편집** 블레이드의 템플릿 내용을 표시하는 섹션에서 49번째 줄 (`                    "dataDisks": [ ]` 라인)을 다음 코드로 바꿉니다.

   ```json
                    "dataDisks": [
                      {
                        "lun": 0,
                        "name": "az104-08-vm1-datadisk0",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      },
                      {
                        "lun": 1,
                        "name": "az104-08-vm1-datadisk1",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      }
                    ]
   ```

    >**참고**: 본 템플릿 섹션에서는 두 개의 관리 디스크를 만들고 Azure Portal을 통해 첫 번째 가상 머신의 스토리지 구성과 유사한 방식으로 **az104-08-vm1**에 연결합니다.

1. **저장**을 클릭하고 **사용자 지정 템플릿** 블레이드로 돌아가 **위에 명시된 이용 약관에 동의함** 확인란을 선택하고 **구입**을 클릭합니다.

    >**참고**: **템플릿에 있는 하나 이상의 리소스가 지원하지 않는 위치에 리소스 그룹이 있습니다. 다른 리소스 그룹을 선택하세요. 라는 메시지는 무시합니다**. 이 경우는 예상한 것으로 무시할 수 있습니다.

    >**참고**: 템플릿 배포가 완료될 때까지 기다립니다. **az104-08-vm1** 가상 머신의 **확장** 블레이드에서 진행 상황을 모니터링할 수 있습니다. 작업은 3분 이내에 완료됩니다.

1. **az104-08-vm1** 블레이드로 돌아가 **작업** 섹션에서, **명령 실행**을 클릭하고, 명령 목록에서 **RunPowerShellScript**를 클릭합니다.    

1. **명령 스크립트 실행** 블레이드에서 다음 내용을 입력하고 **실행**을 클릭하여 간단한 레이아웃 및 고정 프로비전이 있는 두 개의 새로 연결된 디스크로 구성된 드라이브 Z를 만듭니다.

   ```pwsh
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```
    > **참고**: 명령 완료가 확인될 때까지 기다립니다.

#### 작업 4: Azure Portal을 사용하여 영역 복원력 있는 Azure Virtual Machine Scale Sets배포

본 작업에서는 Azure Portal을 사용하여 가용성 영역에 Azure 가상 머신 확장 집합을 배포합니다.

1. Azure Portal에서 **가상 머신 확장 집합**을 검색하여 선택하고 **가상 머신 확장 집합** 블레이드에서 **+ 추가**를 클릭합니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **기본 탭**에서 다음 설정을 지정하고(다른 설정은 기본값으로 남겨둡니다) **다음: 디스크 >** 를릭합니다 로 이동을 클릭합니다.

    | 설정 | 값 | 
    | --- | --- |
    | 구독 | 이 랩에서 사용 중인 Azure 구독의 이름 |    
    | 리소스 그룹 | 새 리소스 그룹 **az104-08-rg02**의 이름 |    
    | 가상 머신 확장 집합 이름 | **az10408vmss0** |
    | 영역 | 가용성 영역을 지원하고 이 랩의 이전 랩에서 가상 머신을 배포하는 데 사용한 것과 다른 Azure 가상 머신을 프로비전할 수 있는 영역 중 하나를 선택합니다. | 
    | 가용성 영역 | **영역 1, 2, 3** |
    | 이미지 | **Windows Server 2016 Datacenter** |
    | Azure Spot 인스턴스 | **아니요** |
    | 크기 | **표준 D2s_v3** |    
    | 사용자 이름 | **학생** |
    | 암호 | **Pa55w.rd1234** |
    | 이미 Windows Server 라이선스가 있으신가요? | **아니요** |

    >**참고**: Windows 가상 머신의 가용성 영역 배포를 지원하는 Azure 영역 목록은 [Azure의 가용성 영역이란 무엇입니까?](https://docs.microsoft.com/ko-kr/azure/availability-zones/az-overview)를 참조하세요

1. **가상 머신 확장 집합 만들기** 블레이드의 **디스크** 탭에서 기본값을 수락하고 **다음: 네트워킹>** 을 클릭합니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭에서 **가상 네트워크** 텍스트 상자 아래의 **가상 네트워크 만들기** 링크를 클릭하고 다음 설정으로 새 가상 네트워크를 만듭니다(다른 값은 기본값을 그대로 둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az104-08-rg02-vnet** |
    | 주소 범위 | **10.82.0.0/20** |
    | 서브넷 이름 | **subnet0** |
    | 서브넷 범위 | **10.82.0.0/24** |
 
    >**참고**: 새 가상 네트워크를 만들고 **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭으로 돌아가면 **가상 네트워크** 값이 **az104-08-rg02-vnet**으로 자동 설정됩니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭에서 네트워크 인터페이스 항목 오른쪽에 있는 **네트워크 인터페이스 편집** 아이콘을 클릭합니다. 

1. **네트워크 인터페이스 편집** 블레이드의 **NIC 네트워크 보안 그룹** 섹션에서 **고급**을 클릭하고 **네트워크 보안 그룹 구성** 드롭다운 목록에서 **새로 만들기**를 클릭합니다. 

1. **네트워크 보안 그룹 만들기** 블레이드에서 다음 설정을 지정합니다(다른 설정은 기본값으로 남겨둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | 이름 | **az10408vmss0-nsg** |

1.  **인바운드 규칙 추가**를 클릭하고 다음 설정으로 인바운드 보안 규칙을 추가합니다(다른 값은 기본값을 그대로 둡니다). 

    | 설정 | 값 | 
    | --- | --- |
    | 원본 | **모두** |
    | 원본 포트 범위 | **\*** |
    | 대상 | **모두** |
    | 대상 포트 범위 | **80** |
    | 프로토콜 | **TCP** |
    | 작업 | **허용** |
    | 우선 순위 | **1010** | 
    | 이름 | **custom-allow-http** |

1. **추가**를 클릭하고 **네트워크 보안 그룹 만들기** 블레이드로 돌아가 **확인**을 클릭합니다.

1. **네트워크 인터페이스 편집** 블레이드로 돌아가 **공용 IP 주소** 섹션에서 **활성화**를 클릭하고 **확인**을 클릭합니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **네트워킹** 탭으로 돌아가 다음 설정을 지정하고(다른 값은 기본값으로 남겨둡니다) **다음: 크기 조정 >** 을 클릭합니다.

    | 설정 | 값 | 
    | --- | --- |
    | 부하 분산 장치 사용 | **예** |
    | 부하 분산 옵션 | **Azure 부하 분산 장치** |
    | 부하 분산 장치 선택 | **(신규) az10408vmss0-lb** |
    | 백 엔드 풀 선택 | **(신규) bepool** |
    
1. **가상 머신 확장 집합 만들기** 블레이드의 **크기 조정** 탭에서 다음 설정을 지정하고(다른 값은 기본값으로 남겨둡니다) **다음: 관리 >** 를 클릭합니다.

    | 설정 | 값 | 
    | --- | --- |
    | 초기 인스턴스 수 | **2** |
    | 크기 조정 정책 | **수동** |

1. **가상 머신 확장 집합 만들기** 블레이드 **관리** 탭에서 다음 설정을 지정하고(다른 값은은 기본값으로 남겨둡니다) **다음: 상태 >** 를 클릭합니다.

    | 설정 | 값 | 
    | --- | --- |
    | 부트 진단 | **해제** |
    
1. **가상 머신 확장 집합 만들기** 블레이드의 **상태** 탭에서 변경이 없는 기본 설정을 검토하고 **다음: 고급 >** 을 클릭합니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **고급** 탭에서 다음 설정을 지정하고(다른 값은 기본값으로 남겨둡니다) **검토+만들기**를 클릭합니다.

    | 설정 | 값 | 
    | --- | --- |
    | 분배 알고리즘 | **고정 분배(여러 영역에는 권장되지 않음)** |
	
	  >**참고**: 현재 **최대 분배** 설정은 작동하지 않습니다.

1. **가상 머신 확장 집합 만들기** 블레이드의 **검토 + 만들기** 탭에서 유효성 검사가 통과되었는지 확인하고 **만들기**를 클릭합니다.

    >**참고**: 가상 머신 확장 집합이 배포될 때까지 기다립니다. 이 작업에 약 5분이 소요됩니다.


#### 작업 5: 가상 머신 확장을 사용하여 Azure Virtual Machine Scale Sets 구성

본 작업에서는 사용자 지정 스크립트 가상 머신 확장을 사용하여 이전 작업에서 배포한 Azure 가상 머신 확장 집합의 인스턴스에 Windows Server Web Server 역할을 설치합니다. 

1. Azure Portal에서 **가상 머신 확장 집합** 블레이드를 새로 고치고 **az10408vms0**을 클릭합니다.

1. **az10408vms0** 블레이드에서 **확장**을 클릭한 다음 **+ 추가**를 클릭합니다.

1. **새 리소스** 블레이드에서 **사용자 지정 스크립트 확장**을 클릭한 다음 **만들기**를 클릭합니다.

1. **확장 설치** 블레이드에서 이 랩에서 스토리지 계정의 **scripts** 컨테이너에 업로드된 **az104-08-install_IIS.ps1** 스크립트로 **이동**하고 해당 스크립트를 **선택**하고 **확인**을 클릭합니다.  

    >**참고**: 확장 설치가 완료된 후 다음 작업을 진행합니다.

1. **az10408vms0** 블레이드의 **설정** 섹션에서 **인스턴스**를 클릭하고 가상 머신 확장 집합의 두 인스턴스 옆에 있는 확인란을 선택한 다음 **업그레이드**를 클릭하고 확인 메시지가 표시되면 **예**를 클릭합니다.

    >**참고**: 업그레이드가 완료된 후 다음 단계를 진행합니다.

1. Azure Portal에서 **부하 분산 장치**를 검색하여 선택하고 부하 분산 장치 목록에서 **az10408vmss0lb**를 클릭합니다.

1. **az10408vmss0lb** 블레이드에서 부하 분산 장치의 프런트 엔드에 할당된 **공용 IP 주소**의 값을 기록한 다음 새 브라우저 탭을 열고 해당 IP 주소로 이동합니다.

    >**참고**: 브라우저 페이지에 Azure 가상 머신 확장 집합 **az10408vms0**의 인스턴스 중 하나의 이름이 표시되는지 확인합니다.


#### 작업 6: Azure 가상 머신 확장 집합에 대한 컴퓨팅 및 스토리지 확장

이 작업에서는 가상 머신 확장 집합 인스턴스의 크기를 변경하고, 자동 크기 조정 설정을 구성하고, 디스크를 연결합니다.

1. Azure Portal의 **az10408vmss0-lb** 블레이드에서 **크기**를 클릭합니다.

1. 사용 가능한 크기 목록에서 **표준 DS1_v2**을 선택하고 **크기 조정**을 클릭합니다.

1. **설정** 섹션에서 **인스턴스**를 클릭하고 가상 머신 확장 집합의 두 인스턴스 옆에 있는 확인란을 선택한 다음 **업그레이드**를 클릭하고 확인 메시지가 표시되면 **예**를 클릭합니다.

1. 인스턴스 목록에서 첫 번째 인스턴스를 나타내는 항목을 클릭하고 확장 집합 인스턴스 블레이드에서 해당 **위치**(Azure 지역 내 영역 머신 확장 집합을 배포한 대상 Azure 영역 중 하나여야 합니다)를 기록합니다. 

1. **az10408vms0 - 인스턴스** 블레이드로 돌아가 확장 집합 인스턴스 블레이드에서 두 번째 인스턴스를 나타내는 항목을 클릭하고 해당 **위치**(Azure 가상 머신 확장 집합을 배포한 대상 Azure 지역의 다른 두 영역 중 하나여야 합니다)를 기록합니다. 

1. **az10408vms0 - 인스턴스** 블레이드로 돌아가 **크기 조정**을 클릭합니다.

1. **az10408vms0 - 크기 조정** 블레이드에서 **사용자 지정 자동 크기 조정** 옵션을 선택하고 다음 설정으로 자동 크기 조정을 구성합니다(다른 값은 기본값을 그대로 남겨둡니다).

    | 설정 | 값 |
    | --- |--- |
    | 크기 조정 모드 | **메트릭 기준 크기 조정** | 

1. **+규칙 추가** 링크를 클릭하고 **크기 조정 규칙** 블레이드에서 다음 설정을 지정합니다(다른 값은 기본값으로 남겨둡니다).

    | 설정 | 값 |
    | --- |--- |
    | 메트릭 원본 | **현재 리소스(az10480vms0)** |
    | 시간 집계 | **최대** |
    | 메트릭 네임스페이스 | **가상 머신 호스트** |
    | 메트릭 이름 | **네트워크 전체 입력* |
    | 연산자 | **보다 큼** |
    | 크기 조정 작업을 트리거하는 메트릭 임계값 | **10** |
    | 기간(분) | **1** |
    | 시간 조직 통계 | **최대** |
    | 작업 | **다음을 기준으로 개수 늘이기** |
    | 인스턴스 수 | **1** |
    | 휴지 시간(분) | **5** |

    >**참고**: 물론 대기 기간의 연장이 없이 가능한 한 빨리 자동 크기 조정을 트리거하는 것이 목적이므로 이러한 값은 현실적인 구성을 나타내지 않습니다. 

1. **추가**를 클릭하고 **az10408vmss0 -확장** 블레이드로 돌아가 다음 설정을 지정합니다(다른 값은 기본값으로 남겨둡니다).

    | 설정 | 값 |
    | --- |--- |
    | 인스턴스 한도 최소 | **1** |
    | 인스턴스 한도 최대 | **3** |
    | 인스턴스 한도 기본값 | **1** |

1. **저장**을 클릭합니다.

1. Azure Portal 오른쪽 상단의 아이콘을 클릭하여 **Azure Cloud Shell**을 엽니다.

1. **Bash**또는 **PowerShell** 중 하나를 선택하라는 메시지가 표시되면 **PowerShell**을 선택합니다.      

    >**참고**: **Cloud Shell**을 처음 시작할 때 **탑재된 스토리지가 없음** 메시지가 나타나면 이 랩에서 사용 중인 구독을 선택하고 **스토리지 만들기**를 클릭합니다. 

1. Cloud Shell 창에서 다음을 실행하여 Azure 가상 머신 확장 집합 **az10408vms0**앞에 있는 부하 분산 장치의 공용 IP 주소를 식별합니다.

   ```pwsh
   $rgName = 'az104-08-rg02'

   $lbpipName = 'az10408vmss0-ip'

   $pip = (Get-AzPublicIpAddress -ResourceGroupName $rgName -Name $lbpipName).IpAddress
   ```
1. Cloud Shell 창에서 다음을 실행하여 HTTP 요청을 Azure 가상 머신 확장 집합 **az10408vms0**의 인스턴스에 호스팅되는 웹 사이트로 보내는 루프를 시작하고 무한히 반복합니다.

   ```pwsh
   while ($true) { Invoke-WebRequest -Uri "http://$pip" }
   ```

1. Cloud Shell 창을 닫지 말고 최소화한 다음 **az10408vmss0-인스턴스** 블레이드로 돌아가 인스턴스 수를 모니터링합니다.

    >**참고**: 몇 분 정도 기다렸다가 **새로 고침**을 클릭해야 할 수 있습니다.

1. 세 번째 인스턴스가 프로비전되면 블레이드로 이동하여 해당 **위치**(이 작업의 앞에서 확인한 처음 두 영역과 달라야 합니다)를 결정합니다. 

1. Cloud Shell 창을 닫습니다. 

1. **az10408vms0** 블레이드에서 **스토리지**를 클릭하고 **+데이터 디스크 추가**를 클릭한 후 다음과 같이 설정된 새 관리 디스크를 연결합니다(다른 값은 기본값으로 남겨둡니다).

    | 설정 | 값 | 
    | --- | --- |
    | LUN | **0** |
    | 크기 | **32** |
    | 계정 유형 | **표준 HDD** |
    | 호스트 캐싱 | **없음** |

1. **az10408vms0** 블레이드의 **설정** 섹션에서 변경 내용을 저장하고 **인스턴스**를 클릭한 다음 가상 머신 확장 집합의 두 인스턴스 옆에 있는 확인란을 선택하고 **업그레이드**를 클릭합니다. 확인 메시지가 표시되면 **예**를 클릭합니다.

    >**참고**: 이전 단계에서 연결된 디스크는 원시 디스크입니다. 사용하기 전에 파티션을 만들고 파일 시스템을 만들어 탑재해야 합니다. 이를 위해 Azure 가상 머신 사용자 지정 스크립트 확장을 사용합니다. 먼저 기존 사용자 지정 스크립트 확장을 제거해야 합니다.

1. **az10408vms0** 블레이드 **설정** 섹션에서 **확장**을 클릭하고 **CustomScriptExtension**을 클릭한 다음 **제거**를 클릭합니다.

    >**참고**: 삭제가 완료될 때까지 기다립니다.

1. Azure Portal 오른쪽 상단에 아이콘을 클릭하여 **Azure Cloud Shell**을 엽니다.

1. **Bash**또는 **PowerShell** 중 하나를 선택하라는 메시지가 표시되면 **PowerShell**을 선택합니다.      

1. Cloud Shell 창의 도구 모음에서 **파일 업로드/다운로드** 아이콘을 클릭하고 드롭다운 메뉴에서 **업로드**를 클릭하고 파일 **\\Allfiles\\Labs\\08\\az104-08-configure_VMSS_disks.ps1**을 Cloud Shell 홈 디렉터리에 업로드합니다.

1. Cloud Shell 창에서 다음 명령을 실행하여 스크립트 콘텐츠를 표시합니다.

   ```pwsh
   Set-Location -Path $HOME

   Get-Content -Path ./az104-08-configure_VMSS_disks.ps1
   ```

    >**참고**: 스크립트는 연결된 디스크를 구성하는 사용자 지정 스크립트 확장을 설치합니다.

1. Cloud Shell 창에서 다음 명령으로 스크립트를 실행하고 Azure 가상 머신 확장 집합의 디스크를 구성합니다.

   ```pwsh
   ./az104-08-configure_VMSS_disks.ps1
   ```

1. Cloud Shell 창을 닫습니다.

1. **az10408vms0** 블레이드의 **설정** 섹션에서 **인스턴스**를 클릭하고 가상 머신 확장 집합의 두 인스턴스 옆에 있는 확인란을 선택한 다음 **업그레이드**를 클릭하고 확인 메시지가 표시되면 **예**를 클릭합니다.

#### 리소스 정리

   >**참고**: 더 이상 사용하지 않는 새로 만든 Azure 리소스를 제거해야 합니다. 사용하지 않는 리소스를 제거하면 해당 비용이 발생하지 않습니다.

1. Azure Portal에서 **Cloud Shell** 창 내부의 **PowerShell** 세션을 엽니다.

1. 다음 명령을 실행하여 본 모듈의 랩 전체에서 만든 모든 리소스 그룹을 나열합니다.

   ```pwsh
   Get-AzResourceGroup -Name 'az104-08*'
   ```

1. 다음 명령을 실행하여 본 모듈의 랩 전체에서 만든 모든 리소스 그룹을 삭제합니다.

   ```pwsh
   Get-AzResourceGroup -Name 'az104-08*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**참고**: 명령은 비동기적으로 실행(-AsJob 매개 변수에 의해 결정)되므로 동일한 PowerShell 세션 내에서 즉시 다른 PowerShell 명령을 실행할 수 있지만 리소스 그룹이 실제로 제거되기까지 몇 분 정도 걸릴 수 있습니다.

#### 리뷰

이 랩에서는 다음 작업을 했습니다.

- Azure Portal 및 Azure Resource Manager 템플릿을 사용하여 영역 복원력 있는 Azure 가상 머신 배포
- 가상 머신 확장을 사용하여 Azure 가상 머신 구성
- Azure 가상 머신을 위해 컴퓨팅 및 스토리지 크기 조정
- Azure Portal을 사용하여 영역 복원력 있는 Azure Virtual Machine Scale Sets 배포
- 가상 머신 확장을 사용하여 Azure Virtual Machine Scale 구성
- Azure Virtual Machine Scale Sets의 컴퓨팅 및 스토리지 크기 조정
